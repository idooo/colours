(function(t){"use strict";var e=function(e,i){var s=this;this.popup_class="ido-colour-popup",this.element_class="ido-colour-picker",this.disabled_class="disabled",this.open_class="active",this.caption_class="rcp-caption",this.color_class="rcp-color",this.$element=t(e),this.$popup=void 0,this.$color=void 0,this.$caption=void 0,this.$input=void 0,this.isOpen=!1,this.caption=i.caption||this.$element.text()||this.$element.data("caption"),this.name=i.name||this.$element.data("name")||this.$element.attr("id")||"color_picker",this.palette=this._parsePalette(i.palette||this.$element.data("palette")||"black, white"),this.color=i.color||this.$element.data("color")||this.palette[0],this.width=i.width||this.$element.data("width")||0,this.disabled=this.$element.attr("disabled")||!1,i.disabled!==void 0&&(this.disabled=i.disabled),this.palette_row_count=i.palette_row_count||this.$element.data("palette-row-count")||5,this.palette_size=i.palette_size||this.$element.data("palette-size")||42,this.onColorSelect=i.onColorSelect||function(){},this.onColorChange=i.onColorChange||function(){},this.onPaletteOver=i.onPaletteOver||function(){},this.onPaletteOut=i.onPaletteOut||function(){},this.init(),t(document).mouseup(function(t){var e=s.$popup;e.is(t.target)||0!==e.has(t.target).length||(e.hide(),s.$element.removeClass(s.open_class)),setTimeout(function(){e.is(":hidden")&&(s.isOpen=!1)},200)})};e.prototype={constructor:e,init:function(){var e=this;if(this.$element.is("input")){var i=this.$element;this.name=i.attr("name")||this.name,this.color=i.attr("value")||this.color,this.$element=t("<div/>").insertBefore(i),i.remove()}return this.$caption=t("<div/>").addClass(this.caption_class).text(this.caption),this.$element.addClass(this.element_class).text(""),this.$color=t("<div/>").addClass(this.color_class).css("background-color",this.color),this.$input=t("<input/>").attr("type","hidden").attr("name",this.name).val(this.color),this.$element.append([this.$caption,this.$color,this.$input]),this.$popup=this._createPopup(),this._resizePopup(),this._bindPaletteCallbacks(),this.width&&this.$element.css("width",this.width),this.$element.on("click",function(){e.changePopupPosition(),e.isOpen?e.close():e.disabled||e.open()}),this.disabled&&this.disable(),this},refresh:function(t){return this.$color.css("background-color",this.color),this.$input.val(this.color),this.$input.attr("name",this.name),this.$caption.text(this.caption),this.width&&this.$element.css("width",this.width),this.disabled?this.disable():this.enable(),t&&(this.palette=this._parsePalette(this.palette),this.$popup.find("> div").remove(),this._createPalette(this.$popup),this._resizePopup(),this._bindPaletteCallbacks(),-1===this.palette.indexOf(this.color)&&(this.color=this.palette[0],this.refresh())),this},_rgb2hex:function(t){var e=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],i=function(t){return isNaN(t)?"00":e[(t-t%16)/16]+e[t%16]};return"#"===t[0]?t:(t=t.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),"#"+i(t[1])+i(t[2])+i(t[3]))},_parsePalette:function(e){if(t.isArray(e))return e;for(var i=e.split(","),s=0;i.length>s;s++)i[s]=t.trim(i[s]);return i},_bindPaletteCallbacks:function(){var e=this,i=this.$popup.find("> div");t.each(i,function(i,s){var o=t(s);o.unbind("mouseover").on("mouseover",function(){return e.onPaletteOver(e._rgb2hex(o.css("background-color")))}),o.unbind("mouseout").on("mouseout",function(){return e.onPaletteOut(e._rgb2hex(o.css("background-color")))})})},_createPalette:function(e){for(var i=this,s=0;i.palette.length>s;s++){var o=t("<div/>").css({"background-color":i.palette[s],width:i.palette_size,height:i.palette_size});o.on("click",function(e){var s=t(this).css("background-color"),o=i.$color.css("background-color");i.$color.css("background-color",s),i.$input.val(i._rgb2hex(s)),i.close(),i.onColorSelect(i._rgb2hex(s)),o!==s&&i.onColorChange(i._rgb2hex(s)),i.color=s,e.stopPropagation(),e.preventDefault()}),e.append(o)}return this},_resizePopup:function(){var e=t(this.$popup.find(">:first-child")[0]),i=e.outerWidth(!0)*this.palette_row_count+1;return this.$popup.css("max-width",i),this},_createPopup:function(){var e=t("<div/>").addClass(this.popup_class).hide();return this._createPalette(e),e.prependTo(this.$element),e},changePopupPosition:function(){return this.$popup.css({"margin-top":this.$element.outerHeight()-this.$element.css("padding-top").replace("px",""),"margin-left":-this.$element.css("padding-left").replace("px","")}),this},open:function(){return this.$popup.show(),this.isOpen=!0,this.$element.addClass(this.open_class),this},close:function(){return this.$popup.hide(),this.isOpen=!1,this.$element.removeClass(this.open_class),this},disable:function(){return this.disabled=!0,this.$element.addClass(this.disabled_class),this},enable:function(){return this.disabled=!1,this.$element.removeClass(this.disabled_class),this}},t.fn.colours=function(i,s){return this.each(function(){var o=t(this),n=o.data("Colours"),a="object"==typeof i&&i;if(n||o.data("Colours",n=new e(this,t.extend({},a))),"string"==typeof i){var l=!1,h=["palette","onPaletteOver","onPaletteOut","palette_size","palette_row_count"];h.indexOf(i)>-1&&(l=!0),n[i]=s,n.refresh(l)}})},t(".colours").colours()})(window.jQuery);